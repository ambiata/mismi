#!/bin/sh -exu

$(dirname $0)/ci.common

VERSION=$(cat $(dirname $0)/../dist/build/autogen/version.txt)
aws s3 --region=ap-southeast-2 cp mismi-s3/dist/build/s3/s3 s3://ambiata-dist/s3/linux/x86_64/$VERSION/s3-$VERSION

MODULES=$(ls mismi-*/*.cabal)

for x in $MODULES; do
    (
        SUBMODULE=$(dirname $x | xargs basename)
        cd $SUBMODULE
        cabal haddock --hoogle

        aws s3 --region=ap-southeast-2 cp --recursive dist/doc/html/$SUBMODULE/ s3://ambiata-doc/$SUBMODULE-haddock/$VERSION
    )
done
